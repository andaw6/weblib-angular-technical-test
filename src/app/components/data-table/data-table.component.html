<div class="bg-card border border-border rounded-lg overflow-hidden">
  <div class="overflow-x-auto">
    <table class="w-full" role="grid" aria-label="Server data table">
      <thead>
        <tr class="border-b border-border bg-muted/50">
          <!-- Select All Checkbox -->
          <th class="w-12 px-4 py-3">
            <input type="checkbox" [checked]="store.pageSelectionState().allSelected"
              [indeterminate]="store.pageSelectionState().someSelected" (change)="store.toggleSelectAll()"
              class="w-4 h-4 rounded border-border bg-muted accent-accent cursor-pointer"
              aria-label="Select all rows on current page" />
          </th>

          <!-- Dynamic Column Headers -->
          @for (column of store.columns(); track column.id; let i = $index) {
          <th class="px-4 py-3 text-left text-sm font-medium text-muted-foreground select-none"
            [attr.data-column-id]="column.id" [attr.draggable]="true" (dragstart)="onDragStart($event, column.id)"
            (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event, column.id)"
            (dragend)="onDragEnd($event)" [class.dragging]="draggedColumnId() === column.id"
            [class.drag-over]="dragOverColumnId() === column.id">
            <div class="flex items-center gap-2">
              <!-- Drag Handle -->
              <span class="drag-handle p-1 hover:bg-muted rounded cursor-grab" (mousedown)="$event.stopPropagation()">
                <svg class="w-3 h-3 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm8-16a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />
                </svg>
              </span>

              <!-- Column Label -->
              <span class="cursor-pointer hover:text-foreground" (click)="
                    column.sortable && store.toggleSort(column.id.toString())
                  " [attr.role]="column.sortable ? 'button' : null" [attr.aria-label]="
                    column.sortable ? 'Sort by ' + column.label : null
                  ">
                {{ column.label }}
              </span>

              <!-- Sort Icon -->
              @if (column.sortable) {
              <span class="sort-icon cursor-pointer" (click)="store.toggleSort(column.id.toString())">
                @if (store.sort().column === column.id) {
                @if (store.sort().direction === "asc") {
                <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
                } @else {
                <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
                }
                } @else {
                <svg class="w-4 h-4 text-muted-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
                }
              </span>
              }
            </div>
          </th>
          }

          <!-- Actions Column -->
          <th class="w-12 px-4 py-3"></th>
        </tr>
      </thead>




      <tbody class="divide-y divide-border">
        @for (server of store.paginatedServers(); track server.id) {
        <tr [attr.data-id]="server.id" class="group transition-colors" [ngClass]="{
              'bg-accent/10': store.selectedIds().has(server.id),
              'bg-warning/5': server.warningsCount > 1,
              'hover:bg-muted/50': !store.selectedIds().has(server.id),
            }" (mouseenter)="store.setHoveredRow(server.id)" (mouseleave)="store.setHoveredRow(null)">
          <!-- Row Checkbox -->
          <td class="px-4 py-3">
            <input type="checkbox" [checked]="store.selectedIds().has(server.id)"
              (change)="onRowSelect(server.id, $event)" (click)="$event.stopPropagation()"
              class="w-4 h-4 rounded border-border bg-muted accent-accent cursor-pointer"
              [attr.aria-label]="'Select ' + server.name" />
          </td>

          <!-- Dynamic Cells -->
          @for (column of store.columns(); track column.id) {
          <td class="px-4 py-3">
            @switch (column.id) {
            @case ("name") {
            <!-- Editable Name Cell -->
            @if (store.uiState().editingCellId === server.id) {
            <input #editInput type="text" [value]="server.name" (keydown)="onEditKeydown($event, server.id)"
              (blur)="onEditBlur($event, server.id)"
              class="w-full bg-muted border border-accent rounded px-2 py-1 text-sm focus:outline-none"
              [attr.aria-label]="'Edit name for ' + server.name" />
            } @else {
            <span class="cursor-pointer hover:text-accent" (dblclick)="startEditing(server.id)"
              [attr.title]="'Double-click to edit'">
              {{ server.name }}
            </span>
            }
            }
            @case ("status") {
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium"
              [ngClass]="getStatusClasses(server.status)">
              <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
              {{ server.status }}
            </span>
            }
            @case ("warningsCount") {
            <span [class]="
                        server.warningsCount > 1
                          ? 'text-warning font-medium'
                          : 'text-muted-foreground'
                      ">
              {{
              server.warningsCount > 0 ? server.warningsCount : "-"
              }}
            </span>
            }
            @default {
            <span class="text-sm">{{
              getCellValue(server, column.id)
              }}</span>
            }
            }
          </td>
          }

          <!-- Actions Button -->
          <td class="px-4 py-3">
            <button (click)="showContextMenu($event, server.id)"
              class="p-1.5 hover:bg-muted rounded-md opacity-0 group-hover:opacity-100 transition-opacity"
              [attr.aria-label]="'Actions for ' + server.name">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
              </svg>
            </button>
          </td>
        </tr>
        }

        @if (store.paginatedServers().length === 0) {
        <tr>
          <td [attr.colspan]="store.columns().length + 2" class="px-4 py-12 text-center text-muted-foreground">
            No servers found matching your criteria.
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <app-table-pagination></app-table-pagination>
</div>

<!-- Context Menu -->
@if (store.uiState().contextMenuPosition) {
 <app-table-context-menu [executeAction]="executeAction" ></app-table-context-menu>
}