<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#16141a',
                        foreground: '#f0f0f0',
                        card: '#1e1b24',
                        border: '#2d2a35',
                        muted: '#252229',
                        'muted-foreground': '#888',
                        accent: '#22c55e',
                        warning: '#f59e0b',
                        destructive: '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
        }

        .dropdown {
            display: none;
        }

        .dropdown.open {
            display: block;
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            border-left: 2px solid #22c55e;
        }

        input:focus,
        button:focus {
            outline: 2px solid #22c55e;
            outline-offset: 2px;
        }

        .editing-cell {
            background: #252229;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1b24;
        }

        ::-webkit-scrollbar-thumb {
            background: #2d2a35;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3d3a45;
        }

        .drag-handle {
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }
    </style>
</head>

<body class="bg-background text-foreground min-h-screen">

    <!-- Header -->
    <header class="border-b border-border px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-semibold tracking-tight">Server Management</h1>
                <p class="text-muted-foreground text-sm mt-1">Manage and monitor your server infrastructure</p>
            </div>
            <div class="flex items-center gap-3">
                <span id="selectedCount" class="text-sm text-muted-foreground hidden">0 selected</span>
                <button onclick="exportData()"
                    class="px-4 py-2 bg-card border border-border rounded-md text-sm hover:bg-muted transition-colors">
                    Export
                </button>
            </div>
        </div>
    </header>

    <main class="p-6">
        <!-- Filter Bar -->
        <div class="bg-card border border-border rounded-lg p-4 mb-4">
            <!-- Search and main filters -->
            <div class="flex flex-wrap items-center gap-3">
                <!-- Search Dropdown Button -->
                <div class="relative">
                    <button onclick="toggleDropdown('searchDropdown')"
                        class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors min-w-[200px]">
                        <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <span id="searchLabel" class="flex-1 text-left text-muted-foreground">Search servers...</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="searchDropdown"
                        class="dropdown absolute top-full left-0 mt-1 w-72 bg-card border border-border rounded-md shadow-lg z-50">
                        <div class="p-3">
                            <input type="text" id="searchInput" placeholder="Type to search..."
                                class="w-full bg-muted border border-border rounded-md px-3 py-2 text-sm placeholder:text-muted-foreground focus:border-accent"
                                oninput="handleSearchInput(event)" onkeydown="handleSearchKeydown(event)">
                        </div>
                        <div id="searchHistorySection" class="border-t border-border">
                            <div class="px-3 py-2 text-xs text-muted-foreground">Recent searches</div>
                            <div id="searchHistoryList" class="pb-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Status Filter (Multi-select) -->
                <div class="relative">
                    <button onclick="toggleDropdown('statusDropdown')"
                        class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors">
                        <span>Status</span>
                        <span id="statusBadge"
                            class="hidden px-1.5 py-0.5 bg-accent text-background text-xs rounded-full">0</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="statusDropdown"
                        class="dropdown absolute top-full left-0 mt-1 w-48 bg-card border border-border rounded-md shadow-lg z-50">
                        <div class="p-2 space-y-1" id="statusOptions"></div>
                    </div>
                </div>

                <!-- Asset Filter with Search Input -->
                <div class="relative">
                    <button onclick="toggleDropdown('assetDropdown')"
                        class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors">
                        <span>Asset</span>
                        <span id="assetBadge"
                            class="hidden px-1.5 py-0.5 bg-accent text-background text-xs rounded-full">0</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="assetDropdown"
                        class="dropdown absolute top-full left-0 mt-1 w-56 bg-card border border-border rounded-md shadow-lg z-50">
                        <!-- Search input for Asset filter -->
                        <div class="p-2 border-b border-border">
                            <input type="text" id="assetSearchInput" placeholder="Search assets..."
                                class="w-full bg-muted border border-border rounded px-2 py-1.5 text-sm placeholder:text-muted-foreground"
                                oninput="filterAssetOptions()">
                        </div>
                        <div class="p-2 space-y-1 max-h-48 overflow-y-auto" id="assetOptions"></div>
                    </div>
                </div>

                <!-- Hardware Filter (NEW) -->
                <div class="relative">
                    <button onclick="toggleDropdown('hardwareDropdown')"
                        class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors">
                        <span>Hardware</span>
                        <span id="hardwareBadge"
                            class="hidden px-1.5 py-0.5 bg-accent text-background text-xs rounded-full">0</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="hardwareDropdown"
                        class="dropdown absolute top-full left-0 mt-1 w-48 bg-card border border-border rounded-md shadow-lg z-50">
                        <div class="p-2 space-y-1" id="hardwareOptions"></div>
                    </div>
                </div>

                <!-- More Filters Toggle -->
                <button id="moreFiltersBtn" onclick="toggleMoreFilters()"
                    class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    <span>More Filters</span>
                </button>

                <!-- Clear Filters -->
                <button id="clearFiltersBtn" onclick="clearAllFilters()"
                    class="hidden px-3 py-2 text-sm text-destructive hover:bg-destructive/10 rounded-md transition-colors">
                    Clear Filters
                </button>
            </div>

            <!-- Extended Filters (More Filters Panel) -->
            <div id="moreFilters" class="hidden mt-4 pt-4 border-t border-border">
                <div class="flex flex-wrap items-start gap-4">
                    <!-- Filter Toggle Controls -->
                    <div class="flex flex-col gap-2">
                        <span class="text-xs text-muted-foreground mb-1">Show/Hide Filters</span>
                        <div class="flex flex-wrap gap-2">
                            <label
                                class="flex items-center gap-2 px-2 py-1 bg-muted rounded text-sm cursor-pointer hover:bg-border">
                                <input type="checkbox" id="toggleTypeFilter" checked
                                    onchange="toggleFilterVisibility('type')" class="w-3 h-3 accent-accent">
                                <span>Type</span>
                            </label>
                            <label
                                class="flex items-center gap-2 px-2 py-1 bg-muted rounded text-sm cursor-pointer hover:bg-border">
                                <input type="checkbox" id="toggleLicenseFilter" checked
                                    onchange="toggleFilterVisibility('license')" class="w-3 h-3 accent-accent">
                                <span>License</span>
                            </label>
                            <label
                                class="flex items-center gap-2 px-2 py-1 bg-muted rounded text-sm cursor-pointer hover:bg-border">
                                <input type="checkbox" id="toggleDateFilter" checked
                                    onchange="toggleFilterVisibility('date')" class="w-3 h-3 accent-accent">
                                <span>Last Updated</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-3 mt-4">
                    <!-- Type Filter -->
                    <div class="relative" id="typeFilterContainer">
                        <button onclick="toggleDropdown('typeDropdown')"
                            class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors">
                            <span>Type</span>
                            <span id="typeBadge"
                                class="hidden px-1.5 py-0.5 bg-accent text-background text-xs rounded-full">0</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="typeDropdown"
                            class="dropdown absolute top-full left-0 mt-1 w-48 bg-card border border-border rounded-md shadow-lg z-50">
                            <div class="p-2 space-y-1" id="typeOptions"></div>
                        </div>
                    </div>

                    <!-- License Filter -->
                    <div class="relative" id="licenseFilterContainer">
                        <button onclick="toggleDropdown('licenseDropdown')"
                            class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors">
                            <span>License</span>
                            <span id="licenseBadge"
                                class="hidden px-1.5 py-0.5 bg-accent text-background text-xs rounded-full">0</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="licenseDropdown"
                            class="dropdown absolute top-full left-0 mt-1 w-48 bg-card border border-border rounded-md shadow-lg z-50">
                            <div class="p-2 space-y-1" id="licenseOptions"></div>
                        </div>
                    </div>

                    <!-- Last Updated Filter (Radio-based) -->
                    <div class="relative" id="dateFilterContainer">
                        <button onclick="toggleDropdown('dateDropdown')"
                            class="flex items-center gap-2 px-3 py-2 bg-muted border border-border rounded-md text-sm hover:bg-border transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span id="dateRangeLabel">Last Updated</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="dateDropdown"
                            class="dropdown absolute top-full left-0 mt-1 w-72 bg-card border border-border rounded-md shadow-lg z-50">
                            <div class="p-3 space-y-2">
                                <!-- Radio options for presets -->
                                <label
                                    class="flex items-center gap-2 px-2 py-1.5 hover:bg-muted rounded cursor-pointer">
                                    <input type="radio" name="datePreset" value="all" checked
                                        onchange="setDatePreset('all')" class="w-4 h-4 accent-accent">
                                    <span class="text-sm">All time</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-2 py-1.5 hover:bg-muted rounded cursor-pointer">
                                    <input type="radio" name="datePreset" value="today"
                                        onchange="setDatePreset('today')" class="w-4 h-4 accent-accent">
                                    <span class="text-sm">Last 24h</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-2 py-1.5 hover:bg-muted rounded cursor-pointer">
                                    <input type="radio" name="datePreset" value="week" onchange="setDatePreset('week')"
                                        class="w-4 h-4 accent-accent">
                                    <span class="text-sm">Last 7 days</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-2 py-1.5 hover:bg-muted rounded cursor-pointer">
                                    <input type="radio" name="datePreset" value="month"
                                        onchange="setDatePreset('month')" class="w-4 h-4 accent-accent">
                                    <span class="text-sm">Last 30 days</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-2 py-1.5 hover:bg-muted rounded cursor-pointer">
                                    <input type="radio" name="datePreset" value="year" onchange="setDatePreset('year')"
                                        class="w-4 h-4 accent-accent">
                                    <span class="text-sm">Last year</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 px-2 py-1.5 hover:bg-muted rounded cursor-pointer">
                                    <input type="radio" name="datePreset" value="custom"
                                        onchange="setDatePreset('custom')" class="w-4 h-4 accent-accent">
                                    <span class="text-sm">Custom range</span>
                                </label>

                                <!-- Custom date inputs (shown when "Custom range" is selected) -->
                                <div id="customDateInputs" class="hidden border-t border-border pt-3 mt-2">
                                    <div class="flex gap-2">
                                        <div class="flex-1">
                                            <label class="text-xs text-muted-foreground">From</label>
                                            <input type="date" id="dateFrom"
                                                class="w-full mt-1 bg-muted border border-border rounded px-2 py-1.5 text-sm">
                                        </div>
                                        <div class="flex-1">
                                            <label class="text-xs text-muted-foreground">To</label>
                                            <input type="date" id="dateTo"
                                                class="w-full mt-1 bg-muted border border-border rounded px-2 py-1.5 text-sm">
                                        </div>
                                    </div>
                                    <button onclick="applyCustomDate()"
                                        class="w-full mt-3 px-3 py-2 bg-accent text-background text-sm rounded-md hover:bg-accent/90 font-medium">
                                        Apply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-card border border-border rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr id="tableHeader" class="border-b border-border bg-muted/50">
                            <th class="w-12 px-4 py-3">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"
                                    class="w-4 h-4 rounded border-border bg-muted accent-accent cursor-pointer">
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-border"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between px-4 py-3 border-t border-border">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-muted-foreground">Rows per page:</span>
                    <select id="rowsPerPage" onchange="changeRowsPerPage()"
                        class="bg-muted border border-border rounded px-2 py-1 text-sm">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <span id="paginationInfo" class="text-sm text-muted-foreground"></span>
                    <div class="flex items-center gap-1">
                        <button onclick="goToPage('first')"
                            class="p-2 hover:bg-muted rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                            id="firstPageBtn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                            </svg>
                        </button>
                        <button onclick="goToPage('prev')"
                            class="p-2 hover:bg-muted rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                            id="prevPageBtn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <span id="pageNumbers" class="flex items-center gap-1"></span>
                        <button onclick="goToPage('next')"
                            class="p-2 hover:bg-muted rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                            id="nextPageBtn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                        <button onclick="goToPage('last')"
                            class="p-2 hover:bg-muted rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                            id="lastPageBtn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Context Menu -->
    <div id="contextMenu" class="hidden fixed bg-card border border-border rounded-lg shadow-xl z-[100] min-w-[200px]">
        <div class="py-1">
            <button onclick="contextAction('openAdmin')"
                class="w-full text-left px-4 py-2 text-sm hover:bg-muted flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                Open Local Admin
            </button>
            <button onclick="contextAction('moveServer')"
                class="w-full text-left px-4 py-2 text-sm hover:bg-muted flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                Move Server
            </button>
            <button onclick="contextAction('connectRemote')"
                class="w-full text-left px-4 py-2 text-sm hover:bg-muted flex items-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
                Connect Remote Services
            </button>
            <div class="border-t border-border my-1"></div>
            <button onclick="contextAction('debug')"
                class="w-full text-left px-4 py-2 text-sm hover:bg-muted flex items-center gap-3 text-warning">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                Advanced Debug Mode
            </button>
        </div>
    </div>

    <script>
        // State
        let state = {
            servers: [],
            filteredServers: [],
            selectedIds: new Set(),
            currentPage: 1,
            rowsPerPage: 10,
            sortColumn: null,
            sortDirection: 'asc',
            searchQuery: '',
            searchHistory: JSON.parse(localStorage.getItem('searchHistory') || '[]'),
            filters: {
                status: [],
                asset: [],
                type: [],
                license: [],
                hardware: [],
                dateFrom: null,
                dateTo: null
            },
            // Updated columns with all required fields from test spec
            columns: JSON.parse(localStorage.getItem('columnOrder') || 'null') || [
                { id: 'name', label: 'Name', sortable: true },
                { id: 'serial', label: 'Serial', sortable: true },
                { id: 'status', label: 'Status', sortable: true },
                { id: 'asset', label: 'Asset', sortable: true },
                { id: 'type', label: 'Type', sortable: true },
                { id: 'serverType', label: 'Server Type', sortable: true },
                { id: 'hardware', label: 'Hardware', sortable: true },
                { id: 'license', label: 'License', sortable: true },
                { id: 'version', label: 'Version', sortable: true },
                { id: 'warningsCount', label: 'Warnings', sortable: true },
                { id: 'lastCommDate', label: 'Last Comm Date', sortable: true }
            ],
            filterVisibility: JSON.parse(localStorage.getItem('filterVisibility') || '{"type": true, "license": true, "date": true}'),
            moreFiltersVisible: localStorage.getItem('moreFiltersVisible') === 'true',
            editingCell: null,
            contextMenuTarget: null,
            hoveredRowId: null,
            lastSelectedId: null,
            assetSearchQuery: ''
        };

        // Filter Options (expanded)
        const filterOptions = {
            status: ['Running', 'Stopped', 'Maintenance', 'Error', 'Pending'],
            asset: ['Production', 'Development', 'Staging', 'Testing', 'QA', 'Integration', 'Demo', 'Backup'],
            type: ['Web Server', 'Database', 'Cache', 'Load Balancer', 'Storage', 'Application', 'API Gateway'],
            license: ['Enterprise', 'Standard', 'Community', 'Trial', 'Professional'],
            hardware: ['Physical', 'Virtual', 'Cloud', 'Container', 'Hybrid'],
            serverType: ['Apache', 'Nginx', 'IIS', 'Node.js', 'Tomcat', 'Custom']
        };

        // Generate Mock Data with all required fields
        function generateMockData(count = 150) {
            const names = ['Apollo', 'Zeus', 'Athena', 'Hermes', 'Poseidon', 'Artemis', 'Ares', 'Hera', 'Demeter', 'Hades'];
            const versions = ['1.0.0', '1.1.0', '1.2.3', '2.0.0', '2.1.0', '3.0.0-beta', '3.1.2', '4.0.0'];
            const servers = [];

            for (let i = 1; i <= count; i++) {
                const baseName = names[Math.floor(Math.random() * names.length)];
                const status = filterOptions.status[Math.floor(Math.random() * filterOptions.status.length)];
                const warningsCount = status === 'Error' ? Math.floor(Math.random() * 10) + 2 : Math.floor(Math.random() * 3);

                servers.push({
                    id: i,
                    name: `${baseName}-${String(i).padStart(3, '0')}`,
                    serial: `SRV-${String(Math.floor(Math.random() * 900000) + 100000)}`,
                    status: status,
                    asset: filterOptions.asset[Math.floor(Math.random() * filterOptions.asset.length)],
                    type: filterOptions.type[Math.floor(Math.random() * filterOptions.type.length)],
                    serverType: filterOptions.serverType[Math.floor(Math.random() * filterOptions.serverType.length)],
                    hardware: filterOptions.hardware[Math.floor(Math.random() * filterOptions.hardware.length)],
                    license: filterOptions.license[Math.floor(Math.random() * filterOptions.license.length)],
                    version: versions[Math.floor(Math.random() * versions.length)],
                    warningsCount: warningsCount,
                    lastCommDate: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                });
            }
            return servers;
        }

        // Initialize
        function init() {
            state.servers = generateMockData(150);
            state.filteredServers = [...state.servers];

            if (state.moreFiltersVisible) {
                document.getElementById('moreFilters').classList.remove('hidden');
            }

            // Restore filter visibility state
            Object.keys(state.filterVisibility).forEach(filter => {
                const checkbox = document.getElementById(`toggle${filter.charAt(0).toUpperCase() + filter.slice(1)}Filter`);
                if (checkbox) checkbox.checked = state.filterVisibility[filter];
                toggleFilterVisibility(filter, false);
            });

            renderFilterOptions();
            renderTableHeader();
            renderSearchHistory();
            applyFilters();

            // Event listeners
            document.addEventListener('click', handleDocumentClick);
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('keydown', handleGlobalKeydown);
        }

        // Debounce
        function debounce(fn, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        // Render Filter Options
        function renderFilterOptions() {
            ['status', 'asset', 'type', 'license', 'hardware'].forEach(filterType => {
                const container = document.getElementById(`${filterType}Options`);
                if (!container) return;

                let options = filterOptions[filterType];

                // For asset filter, apply search filtering
                if (filterType === 'asset' && state.assetSearchQuery) {
                    options = options.filter(opt =>
                        opt.toLowerCase().includes(state.assetSearchQuery.toLowerCase())
                    );
                }

                // Disable filter if only one option
                const button = container.closest('.relative')?.querySelector('button');
                if (button) {
                    if (filterOptions[filterType].length <= 1) {
                        button.disabled = true;
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        button.disabled = false;
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                container.innerHTML = options.map(option => `
          <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-muted rounded cursor-pointer">
            <input type="checkbox" value="${option}" onchange="handleFilterChange('${filterType}')" 
              ${state.filters[filterType].includes(option) ? 'checked' : ''}
              class="w-4 h-4 rounded border-border bg-muted accent-accent">
            <span class="text-sm">${option}</span>
          </label>
        `).join('');
            });
        }

        // Filter Asset Options
        function filterAssetOptions() {
            state.assetSearchQuery = document.getElementById('assetSearchInput').value;
            renderFilterOptions();
        }

        // Toggle Filter Visibility (More Filters panel feature)
        function toggleFilterVisibility(filterType, save = true) {
            const container = document.getElementById(`${filterType}FilterContainer`);
            const checkbox = document.getElementById(`toggle${filterType.charAt(0).toUpperCase() + filterType.slice(1)}Filter`);

            if (container && checkbox) {
                state.filterVisibility[filterType] = checkbox.checked;
                container.classList.toggle('hidden', !checkbox.checked);

                if (save) {
                    localStorage.setItem('filterVisibility', JSON.stringify(state.filterVisibility));
                }
            }
        }

        // Render Table Header with drag handle
        function renderTableHeader() {
            const header = document.getElementById('tableHeader');
            const checkboxTh = header.querySelector('th');

            header.innerHTML = '';
            header.appendChild(checkboxTh);

            state.columns.forEach((col, index) => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-sm font-medium text-muted-foreground select-none';
                th.dataset.columnId = col.id;

                th.innerHTML = `
          <div class="flex items-center gap-2">
            <!-- Drag Handle -->
            <span class="drag-handle p-1 hover:bg-muted rounded cursor-grab" draggable="true">
              <svg class="w-3 h-3 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm8-16a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
              </svg>
            </span>
            <span class="cursor-pointer hover:text-foreground" onclick="handleSort('${col.id}')">${col.label}</span>
            ${col.sortable ? `
              <span class="sort-icon text-muted-foreground/50 cursor-pointer" onclick="handleSort('${col.id}')">
                ${state.sortColumn === col.id
                            ? (state.sortDirection === 'asc'
                                ? '<svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>'
                                : '<svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>')
                            : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>'
                        }
              </span>
            ` : ''}
          </div>
        `;

                // Drag and drop on handle only
                const dragHandle = th.querySelector('.drag-handle');
                dragHandle.addEventListener('dragstart', (e) => handleDragStart(e, col.id));
                th.addEventListener('dragover', handleDragOver);
                th.addEventListener('dragleave', handleDragLeave);
                th.addEventListener('drop', handleDrop);
                th.addEventListener('dragend', handleDragEnd);

                header.appendChild(th);
            });

            // Actions column
            const actionsTh = document.createElement('th');
            actionsTh.className = 'w-12 px-4 py-3';
            header.appendChild(actionsTh);
        }

        // Render Table Body
        function renderTableBody() {
            const tbody = document.getElementById('tableBody');
            const start = (state.currentPage - 1) * state.rowsPerPage;
            const end = start + state.rowsPerPage;
            const pageData = state.filteredServers.slice(start, end);

            tbody.innerHTML = pageData.map(server => {
                const isSelected = state.selectedIds.has(server.id);
                const hasWarning = server.warningsCount > 1;

                return `
          <tr 
            data-id="${server.id}" 
            class="group hover:bg-muted/50 transition-colors ${isSelected ? 'bg-accent/10' : ''} ${hasWarning ? 'bg-warning/5' : ''}"
            onmouseenter="state.hoveredRowId = ${server.id}"
            onmouseleave="state.hoveredRowId = null"
          >
            <td class="px-4 py-3">
              <input 
                type="checkbox" 
                ${isSelected ? 'checked' : ''} 
                onchange="toggleSelect(${server.id}, event)"
                onclick="event.stopPropagation()"
                class="w-4 h-4 rounded border-border bg-muted accent-accent cursor-pointer"
              >
            </td>
            ${state.columns.map(col => {
                    if (col.id === 'name') {
                        return `
                  <td class="px-4 py-3">
                    <span 
                      class="cursor-pointer hover:text-accent ${state.editingCell === server.id ? 'hidden' : ''}"
                      ondblclick="startEditing(${server.id})"
                    >${server.name}</span>
                    <input 
                      type="text" 
                      value="${server.name}"
                      class="${state.editingCell === server.id ? '' : 'hidden'} bg-muted border border-accent rounded px-2 py-1 text-sm w-full editing-input"
                      data-server-id="${server.id}"
                      onkeydown="handleEditKeydown(event, ${server.id})"
                      onblur="cancelEditing()"
                    >
                  </td>
                `;
                    }
                    if (col.id === 'status') {
                        const statusColors = {
                            'Running': 'bg-green-500/20 text-green-400',
                            'Stopped': 'bg-gray-500/20 text-gray-400',
                            'Maintenance': 'bg-blue-500/20 text-blue-400',
                            'Error': 'bg-red-500/20 text-red-400',
                            'Pending': 'bg-yellow-500/20 text-yellow-400'
                        };
                        return `
                  <td class="px-4 py-3">
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${statusColors[server.status] || 'bg-gray-500/20 text-gray-400'}">
                      <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                      ${server.status}
                    </span>
                  </td>
                `;
                    }
                    if (col.id === 'warningsCount') {
                        return `
                  <td class="px-4 py-3 ${server.warningsCount > 1 ? 'text-warning font-medium' : 'text-muted-foreground'}">
                    ${server.warningsCount > 0 ? server.warningsCount : '-'}
                  </td>
                `;
                    }
                    return `<td class="px-4 py-3 text-sm">${server[col.id] || '-'}</td>`;
                }).join('')}
            <td class="px-4 py-3">
              <button 
                onclick="showContextMenuForRow(event, ${server.id})"
                class="p-1.5 hover:bg-muted rounded-md opacity-0 group-hover:opacity-100 transition-opacity"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                </svg>
              </button>
            </td>
          </tr>
        `;
            }).join('');

            updateSelectAllCheckbox();
            renderPagination();
        }

        // Pagination
        function renderPagination() {
            const total = state.filteredServers.length;
            const totalPages = Math.ceil(total / state.rowsPerPage) || 1;
            const start = total > 0 ? (state.currentPage - 1) * state.rowsPerPage + 1 : 0;
            const end = Math.min(state.currentPage * state.rowsPerPage, total);

            document.getElementById('paginationInfo').textContent = `${start}-${end} of ${total}`;

            document.getElementById('firstPageBtn').disabled = state.currentPage === 1;
            document.getElementById('prevPageBtn').disabled = state.currentPage === 1;
            document.getElementById('nextPageBtn').disabled = state.currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = state.currentPage === totalPages;

            // Page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            let pages = [];

            if (totalPages <= 5) {
                pages = Array.from({ length: totalPages }, (_, i) => i + 1);
            } else {
                if (state.currentPage <= 3) {
                    pages = [1, 2, 3, 4, '...', totalPages];
                } else if (state.currentPage >= totalPages - 2) {
                    pages = [1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
                } else {
                    pages = [1, '...', state.currentPage - 1, state.currentPage, state.currentPage + 1, '...', totalPages];
                }
            }

            pageNumbers.innerHTML = pages.map(p => {
                if (p === '...') {
                    return '<span class="px-2 text-muted-foreground">...</span>';
                }
                return `
          <button 
            onclick="goToPage(${p})"
            class="w-8 h-8 rounded-md text-sm ${p === state.currentPage ? 'bg-accent text-background' : 'hover:bg-muted'}"
          >${p}</button>
        `;
            }).join('');
        }

        function goToPage(page) {
            const totalPages = Math.ceil(state.filteredServers.length / state.rowsPerPage) || 1;

            if (page === 'first') state.currentPage = 1;
            else if (page === 'prev') state.currentPage = Math.max(1, state.currentPage - 1);
            else if (page === 'next') state.currentPage = Math.min(totalPages, state.currentPage + 1);
            else if (page === 'last') state.currentPage = totalPages;
            else state.currentPage = page;

            renderTableBody();
        }

        function changeRowsPerPage() {
            state.rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            state.currentPage = 1;
            renderTableBody();
        }

        // Search (Dropdown-based)
        function handleSearchInput(e) {
            state.searchQuery = e.target.value;
            updateSearchLabel();
            applyFilters();
        }

        function handleSearchKeydown(e) {
            if (e.key === 'Enter' && state.searchQuery.trim()) {
                addToSearchHistory(state.searchQuery.trim());
                toggleDropdown('searchDropdown');
            }
        }

        function addToSearchHistory(query) {
            state.searchHistory = [query, ...state.searchHistory.filter(q => q !== query)].slice(0, 3);
            localStorage.setItem('searchHistory', JSON.stringify(state.searchHistory));
            renderSearchHistory();
        }

        function renderSearchHistory() {
            const list = document.getElementById('searchHistoryList');
            const section = document.getElementById('searchHistorySection');

            if (state.searchHistory.length > 0) {
                section.classList.remove('hidden');
                list.innerHTML = state.searchHistory.map(q => `
          <button 
            onclick="selectSearchHistory('${q}')"
            class="w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center gap-2"
          >
            <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            ${q}
          </button>
        `).join('');
            } else {
                section.classList.add('hidden');
            }
        }

        function selectSearchHistory(query) {
            document.getElementById('searchInput').value = query;
            state.searchQuery = query;
            updateSearchLabel();
            toggleDropdown('searchDropdown');
            applyFilters();
        }

function updateSearchLabel() {
            const label = document.getElementById('searchLabel');
            const button = label.closest('button');
            if (state.searchQuery) {
                label.textContent = state.searchQuery;
                label.classList.remove('text-muted-foreground');
                // Add active visual state to the search button
                if (button) {
                    button.classList.add('border-accent', 'bg-accent/10');
                    button.classList.remove('border-border');
                }
            } else {
                label.textContent = 'Search servers...';
                label.classList.add('text-muted-foreground');
                // Remove active visual state from the search button
                if (button) {
                    button.classList.remove('border-accent', 'bg-accent/10');
                    button.classList.add('border-border');
                }
            }
        }

        // Filters
        function toggleDropdown(id) {
            document.querySelectorAll('.dropdown').forEach(d => {
                if (d.id !== id) d.classList.remove('open');
            });
            document.getElementById(id).classList.toggle('open');
        }

        function handleFilterChange(filterType) {
            const checkboxes = document.querySelectorAll(`#${filterType}Options input:checked`);
            state.filters[filterType] = Array.from(checkboxes).map(cb => cb.value);
            updateFilterBadge(filterType);
            applyFilters();
        }

function updateFilterBadge(filterType) {
            const badge = document.getElementById(`${filterType}Badge`);
            if (!badge) return;

            const count = state.filters[filterType].length;
            // Get the parent button to apply active styles
            const button = badge.closest('button');

            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
                // Add active visual state to the button
                if (button) {
                    button.classList.add('border-accent', 'bg-accent/10');
                    button.classList.remove('border-border');
                }
            } else {
                badge.classList.add('hidden');
                // Remove active visual state from the button
                if (button) {
                    button.classList.remove('border-accent', 'bg-accent/10');
                    button.classList.add('border-border');
                }
            }
        }

        function toggleMoreFilters() {
            state.moreFiltersVisible = !state.moreFiltersVisible;
            document.getElementById('moreFilters').classList.toggle('hidden');
            localStorage.setItem('moreFiltersVisible', state.moreFiltersVisible);
        }

function setDatePreset(preset) {
            const customInputs = document.getElementById('customDateInputs');
            const dateLabel = document.getElementById('dateRangeLabel');
            const dateButton = dateLabel.closest('button');

            if (preset === 'custom') {
                customInputs.classList.remove('hidden');
                return;
            } else {
                customInputs.classList.add('hidden');
            }

            if (preset === 'all') {
                state.filters.dateFrom = null;
                state.filters.dateTo = null;
                dateLabel.textContent = 'Last Updated';
                // Remove active visual state from the date button
                if (dateButton) {
                    dateButton.classList.remove('border-accent', 'bg-accent/10');
                    dateButton.classList.add('border-border');
                }
            } else {
                const today = new Date();
                let from = new Date();

                switch (preset) {
                    case 'today':
                        from = today;
                        break;
                    case 'week':
                        from.setDate(today.getDate() - 7);
                        break;
                    case 'month':
                        from.setDate(today.getDate() - 30);
                        break;
                    case 'year':
                        from.setFullYear(today.getFullYear() - 1);
                        break;
                }

                state.filters.dateFrom = from.toISOString().split('T')[0];
                state.filters.dateTo = today.toISOString().split('T')[0];

                const labels = { today: 'Last 24h', week: 'Last 7 days', month: 'Last 30 days', year: 'Last year' };
                dateLabel.textContent = labels[preset] || 'Last Updated';
                // Add active visual state to the date button
                if (dateButton) {
                    dateButton.classList.add('border-accent', 'bg-accent/10');
                    dateButton.classList.remove('border-border');
                }
            }

            toggleDropdown('dateDropdown');
            applyFilters();
        }

function applyCustomDate() {
            state.filters.dateFrom = document.getElementById('dateFrom').value || null;
            state.filters.dateTo = document.getElementById('dateTo').value || null;

            const dateLabel = document.getElementById('dateRangeLabel');
            const dateButton = dateLabel.closest('button');

            if (state.filters.dateFrom || state.filters.dateTo) {
                dateLabel.textContent = 'Custom Range';
                // Add active visual state to the date button
                if (dateButton) {
                    dateButton.classList.add('border-accent', 'bg-accent/10');
                    dateButton.classList.remove('border-border');
                }
            }

            toggleDropdown('dateDropdown');
            applyFilters();
        }

function clearAllFilters() {
            state.searchQuery = '';
            state.filters = { status: [], asset: [], type: [], license: [], hardware: [], dateFrom: null, dateTo: null };

            document.getElementById('searchInput').value = '';
            updateSearchLabel();
            document.querySelectorAll('.dropdown input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="datePreset"]').forEach(r => r.checked = r.value === 'all');
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('dateRangeLabel').textContent = 'Last Updated';
            document.getElementById('customDateInputs').classList.add('hidden');

            // Reset date button active state
            const dateLabel = document.getElementById('dateRangeLabel');
            const dateButton = dateLabel.closest('button');
            if (dateButton) {
                dateButton.classList.remove('border-accent', 'bg-accent/10');
                dateButton.classList.add('border-border');
            }

            ['status', 'asset', 'type', 'license', 'hardware'].forEach(updateFilterBadge);
            applyFilters();
        }

        function applyFilters() {
            state.filteredServers = state.servers.filter(server => {
// Search - matches against multiple columns (name, serial, asset)
  if (state.searchQuery) {
  const query = state.searchQuery.toLowerCase();
  const matchesName = server.name.toLowerCase().includes(query);
  const matchesSerial = server.serial.toLowerCase().includes(query);
  const matchesAsset = server.asset.toLowerCase().includes(query);
  if (!matchesName && !matchesSerial && !matchesAsset) {
  return false;
  }
  }

                // Status
                if (state.filters.status.length > 0 && !state.filters.status.includes(server.status)) {
                    return false;
                }

                // Asset
                if (state.filters.asset.length > 0 && !state.filters.asset.includes(server.asset)) {
                    return false;
                }

                // Type
                if (state.filters.type.length > 0 && !state.filters.type.includes(server.type)) {
                    return false;
                }

                // License
                if (state.filters.license.length > 0 && !state.filters.license.includes(server.license)) {
                    return false;
                }

                // Hardware
                if (state.filters.hardware.length > 0 && !state.filters.hardware.includes(server.hardware)) {
                    return false;
                }

                // Date range (using lastCommDate)
                if (state.filters.dateFrom && server.lastCommDate < state.filters.dateFrom) {
                    return false;
                }
                if (state.filters.dateTo && server.lastCommDate > state.filters.dateTo) {
                    return false;
                }

                return true;
            });

            // Apply sort
            if (state.sortColumn) {
                state.filteredServers.sort((a, b) => {
                    let aVal = a[state.sortColumn];
                    let bVal = b[state.sortColumn];

                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }

                    if (aVal < bVal) return state.sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            state.currentPage = 1;
            updateClearFiltersButton();
            renderTableBody();
        }

        function updateClearFiltersButton() {
            const hasFilters = state.searchQuery ||
                Object.values(state.filters).some(f => Array.isArray(f) ? f.length > 0 : f !== null);

            document.getElementById('clearFiltersBtn').classList.toggle('hidden', !hasFilters);
        }

        // Sorting
        function handleSort(columnId) {
            if (state.sortColumn === columnId) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = columnId;
                state.sortDirection = 'asc';
            }

            renderTableHeader();
            applyFilters();
        }

        // Drag and Drop
        let draggedColumn = null;

        function handleDragStart(e, columnId) {
            draggedColumn = columnId;
            e.target.closest('th').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            const th = e.target.closest('th');
            if (th && th.dataset.columnId) {
                th.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.target.closest('th')?.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetTh = e.target.closest('th');
            const targetColumn = targetTh?.dataset.columnId;

            if (draggedColumn && targetColumn && draggedColumn !== targetColumn) {
                const fromIndex = state.columns.findIndex(c => c.id === draggedColumn);
                const toIndex = state.columns.findIndex(c => c.id === targetColumn);

                const [removed] = state.columns.splice(fromIndex, 1);
                state.columns.splice(toIndex, 0, removed);

                localStorage.setItem('columnOrder', JSON.stringify(state.columns));
                renderTableHeader();
                renderTableBody();
            }

            targetTh?.classList.remove('drag-over');
        }

        function handleDragEnd(e) {
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('dragging', 'drag-over');
            });
            draggedColumn = null;
        }

        // Selection
        function toggleSelect(id, event) {
            if (event.shiftKey && state.lastSelectedId !== null) {
                const start = state.filteredServers.findIndex(s => s.id === state.lastSelectedId);
                const end = state.filteredServers.findIndex(s => s.id === id);
                const [from, to] = [Math.min(start, end), Math.max(start, end)];

                for (let i = from; i <= to; i++) {
                    state.selectedIds.add(state.filteredServers[i].id);
                }
            } else if (event.ctrlKey || event.metaKey) {
                if (state.selectedIds.has(id)) {
                    state.selectedIds.delete(id);
                } else {
                    state.selectedIds.add(id);
                }
            } else {
                if (state.selectedIds.has(id)) {
                    state.selectedIds.delete(id);
                } else {
                    state.selectedIds.add(id);
                }
            }

            state.lastSelectedId = id;
            updateSelectedCount();
            renderTableBody();
        }

        function toggleSelectAll() {
            const allChecked = document.getElementById('selectAll').checked;
            const start = (state.currentPage - 1) * state.rowsPerPage;
            const end = start + state.rowsPerPage;
            const pageData = state.filteredServers.slice(start, end);

            pageData.forEach(server => {
                if (allChecked) {
                    state.selectedIds.add(server.id);
                } else {
                    state.selectedIds.delete(server.id);
                }
            });

            updateSelectedCount();
            renderTableBody();
        }

        function updateSelectAllCheckbox() {
            const start = (state.currentPage - 1) * state.rowsPerPage;
            const end = start + state.rowsPerPage;
            const pageData = state.filteredServers.slice(start, end);
            const allSelected = pageData.length > 0 && pageData.every(s => state.selectedIds.has(s.id));

            document.getElementById('selectAll').checked = allSelected;
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('selectedCount');
            const count = state.selectedIds.size;

            if (count > 0) {
                countEl.textContent = `${count} selected`;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }

        // Inline Editing
        function startEditing(id) {
            state.editingCell = id;
            renderTableBody();

            setTimeout(() => {
                const input = document.querySelector(`.editing-input[data-server-id="${id}"]`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 0);
        }

        function handleEditKeydown(e, id) {
            if (e.key === 'Enter') {
                saveEdit(id, e.target.value);
            } else if (e.key === 'Escape') {
                cancelEditing();
            } else if (e.key === 'Tab') {
                e.preventDefault();
                saveEdit(id, e.target.value);

                const currentIndex = state.filteredServers.findIndex(s => s.id === id);
                const nextServer = state.filteredServers[currentIndex + 1];
                if (nextServer) {
                    startEditing(nextServer.id);
                }
            }
        }

        function saveEdit(id, newName) {
            const server = state.servers.find(s => s.id === id);
            if (server && newName.trim()) {
                server.name = newName.trim();
            }
            state.editingCell = null;
            renderTableBody();
        }

        function cancelEditing() {
            state.editingCell = null;
            renderTableBody();
        }

        // Context Menu
        function handleContextMenu(e) {
            const row = e.target.closest('tr[data-id]');
            if (row) {
                e.preventDefault();
                const id = parseInt(row.dataset.id);
                state.contextMenuTarget = state.selectedIds.size > 0 ? Array.from(state.selectedIds) : [id];
                showContextMenu(e.clientX, e.clientY);
            }
        }

        function showContextMenuForRow(e, id) {
            e.stopPropagation();
            state.contextMenuTarget = state.selectedIds.size > 0 ? Array.from(state.selectedIds) : [id];
            showContextMenu(e.clientX, e.clientY);
        }

        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.classList.remove('hidden');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.add('hidden');
            state.contextMenuTarget = null;
        }

        function contextAction(action) {
            const targets = state.contextMenuTarget || [];
            const serverNames = targets.map(id => state.servers.find(s => s.id === id)?.name).filter(Boolean);

            switch (action) {
                case 'openAdmin':
                    alert(`Opening Local Admin for: ${serverNames.join(', ')}`);
                    break;
                case 'moveServer':
                    alert(`Moving servers: ${serverNames.join(', ')}`);
                    break;
                case 'connectRemote':
                    alert(`Connecting remote services for: ${serverNames.join(', ')}`);
                    break;
                case 'debug':
                    alert(`Enabling Advanced Debug Mode for: ${serverNames.join(', ')}`);
                    break;
            }

            hideContextMenu();
        }

        // Document handlers
        function handleDocumentClick(e) {
            if (!e.target.closest('.dropdown') && !e.target.closest('button')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            }

            if (!e.target.closest('#contextMenu')) {
                hideContextMenu();
            }
        }

        function handleGlobalKeydown(e) {
            if (e.key === 'Escape') {
                hideContextMenu();
                cancelEditing();
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            }
        }

        // Export
        function exportData() {
            const data = state.selectedIds.size > 0
                ? state.filteredServers.filter(s => state.selectedIds.has(s.id))
                : state.filteredServers;

            const csv = [
                state.columns.map(c => c.label).join(','),
                ...data.map(row => state.columns.map(c => row[c.id]).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'servers-export.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
